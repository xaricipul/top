<!DOCTYPE html>
<html lang="tr">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ülkeler Oyunu</title>
<meta name="description" content="TakipBiz">
<meta name="author" content="adierebel">
<link rel="stylesheet" href="assets/css/reset.css?v=1.0">
<link rel="stylesheet" href="assets/css/style.css?v=1.0">
<script type="text/javascript" src="words.js"></script>
<script type="text/javascript" src="msg.js"></script>
<script type="text/javascript" src="assets/tts/speakClient.js"></script>
<script type="text/javascript" src="assets/js/jquery.js"></script>
<script type="text/javascript" src="assets/js/socket.io.js"></script>
<script type="text/javascript" src="assets/js/connection.js"></script>
<script src="https://code.responsivevoice.org/responsivevoice.js?key=2u7Qd768"></script>
<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>

<head>
  <title>Ülkeler Oyunu</title>
</head>
<style>
  #myCanvas {
    display: block;
    margin: 150px auto;
    border: 1px solid #ddd;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    background-color: rgba(0, 0, 0, 0);
    border-radius: 10px;
    transition: all 0.3s ease-in-out;
    position: relative;
  }

  #progressCanvas {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 400px;
    height: 100px;
    background: linear-gradient(135deg, rgba(245, 245, 245, 0.95) 0%, rgba(220, 220, 220, 0.95) 100%);
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    z-index: 100;
    padding: 10px;
  }

  @keyframes shake {
    0% {
      transform: translate(2px, 2px) rotate(0deg);
    }

    10% {
      transform: translate(-2px, -3px) rotate(-2deg);
    }

    20% {
      transform: translate(-4px, 1px) rotate(2deg);
    }

    30% {
      transform: translate(4px, -1px) rotate(-2deg);
    }

    40% {
      transform: translate(2px, 2px) rotate(1deg);
    }

    50% {
      transform: translate(-2px, -2px) rotate(2deg);
    }

    60% {
      transform: translate(-4px, 1px) rotate(0deg);
    }

    70% {
      transform: translate(4px, -3px) rotate(-1deg);
    }

    80% {
      transform: translate(-2px, 2px) rotate(2deg);
    }

    90% {
      transform: translate(2px, -2px) rotate(-2deg);
    }

    100% {
      transform: translate(2px, 2px) rotate(0deg);
    }
  }

  @keyframes explosion {
    0% {
      transform: scale(0);
      opacity: 1;
    }

    100% {
      transform: scale(1.5);
      opacity: 0;
    }
  }

  .shake {
    animation: shake 0.5s ease-in-out infinite;
    box-shadow: 0 0 15px red, 0 0 30px orange, 0 0 45px yellow;
  }

  .explosion-effect {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 50px;
    height: 50px;
    background-color: red;
    border-radius: 50%;
    opacity: 0;
    transform: translate(-50%, -50%) scale(0);
    animation: explosion 0.5s ease-out forwards;
    pointer-events: none;
  }

  .explosion-container {
    position: relative;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }

  #newsTicker {
    position: absolute;
    top: 570px;
    left: 50%;
    transform: translateX(-50%);
    width: 400px;
    background: linear-gradient(135deg, rgba(245, 245, 245, 0.95) 0%, rgba(220, 220, 220, 0.95) 100%);
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    z-index: 100;
    padding: 10px;
    overflow: hidden;
    white-space: nowrap;
  }
  .ticker-content {
  display: inline-block;
  white-space: nowrap;
  transform: translateX(400px); /* 400px içinden başlat */
  will-change: transform;
}

@keyframes ticker {
  from {
    transform: translateX(400px); /* 400px içinden başlat */
  }

  to {
    transform: translateX(-100%); /* İçeriğin sonuna kadar kaydır */
  }
}


</style>

<body>
  <div id="canvasContainer" class="explosion-container">
    <canvas id="myCanvas" width="400" height="400"></canvas>
  </div>
  <canvas id="progressCanvas"></canvas>
  <div id="newsTicker">
    <div class="ticker-content" id="tickerContent"></div>
  </div>

  <script>
  let countdownTime = 500; // 30 saniyelik geri sayım

  function startCountdown() {
    const countdownInterval = setInterval(() => {
      countdownTime--;

      // Dakika ve saniye olarak formatla
      const minutes = Math.floor(countdownTime / 60);
      const seconds = countdownTime % 60;

      // Countdown timer'ı progressCanvas üzerine çiz
      progressCtx.clearRect(0, 0, progressCanvas.width, progressCanvas.height); // Önce progressCanvas'ı temizle

      updateProgressCanvas(); // İlerleme çubuğunu güncelle

      // Countdown timer'ı çiz
      progressCtx.fillStyle = "black";
      progressCtx.font = "bold 20px Arial";
      progressCtx.textAlign = "right";
      progressCtx.fillText(`${minutes}:${seconds < 10 ? '0' + seconds : seconds}`, progressCanvas.width - 20, 30);

      // Süre dolduğunda işlemler
      if (countdownTime <= 0) {
        clearInterval(countdownInterval); // Timer'ı durdur
        finishGame = true; // Oyunu bitir
        determineWinner(); // Kazanan ülkeyi belirle
      }
    }, 1000);
  }

  function determineWinner() {
    let largestCountry = countries.reduce((max, country) => max.size > country.size ? max : country);

    // Kazanan ülkeyi belirle ve oyun işlemlerini gerçekleştir
    if (largestCountry) {
      finishGame = true;
      showFireworkGif(largestCountry); // Kazanan ülkeyi ve kutlamaları göster
      resizeCanvas(); // Canvas boyutunu değiştir
    }
  }

  function resizeCanvas() {
    canvas.width = 400;
    canvas.height = 400;
  }

  $(document).ready(() => {
    startCountdown(); // Sayfa yüklendiğinde geri sayımı başlat
  });

function updateNewsTicker() {
  const tickerContent = document.getElementById('tickerContent');
  tickerContent.innerHTML = '';

  countries.forEach((country, index) => {
    const countryItem = document.createElement('span');
    countryItem.innerHTML = `<img src="${country.imgUrl}" alt="${country.name}" style="width: 20px; vertical-align: middle; margin-right: 10px;"> <strong style="font-size: 20px; margin-right: 20px;">${index + 1}. ${country.name}</strong>`;
    tickerContent.appendChild(countryItem);
  });

  const width = tickerContent.scrollWidth;
  const animationDuration = width / 120; // Hızı ayarlamak için süreyi hesaplarsınız
  tickerContent.style.animation = `ticker ${animationDuration}s linear infinite`;

  // Döngü sonunda hemen tekrar başlatmak için
  tickerContent.addEventListener('animationiteration', () => {
    tickerContent.style.animation = 'none';
    setTimeout(() => {
      tickerContent.style.animation = `ticker ${animationDuration}s linear infinite`;
    }, 0); // Animasyonu hemen tekrar başlat
  });
}

$(document).ready(() => {
  updateNewsTicker();
});

    let usernames = new Map();
    let connection = new TikTokIOConnection(undefined);

    let iconList = [];
    let nextId = 1;
    let winner = [];
    const canvas = document.getElementById("myCanvas");
    const ctx = canvas.getContext("2d");
    const progressCanvas = document.getElementById("progressCanvas");
    const progressCtx = progressCanvas.getContext("2d");
    const initialCountrySize = 40;  // Tüm ülkelerin başlangıç boyutu

    const countries = [
      { name: "Turkey", imgUrl: "TR.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.5, y: 0.5 }, joinCode: "1,turkey,tr" },
      { name: "USA", imgUrl: "US.png", size: initialCountrySize, users: [], x: 100, y: 100, moveSpeed: { x: 0.7, y: 0.3 }, joinCode: "2,usa,us" },
      { name: "Germany", imgUrl: "DE.png", size: initialCountrySize, users: [], x: 200, y: 200, moveSpeed: { x: 0.5, y: 0.5 }, joinCode: "3,germany,de" },
      { name: "France", imgUrl: "FR.png", size: initialCountrySize, users: [], x: 300, y: 0, moveSpeed: { x: 0.5, y: 0.5 }, joinCode: "4,france,fr" },
      { name: "Brazil", imgUrl: "BR.png", size: initialCountrySize, users: [], x: 0, y: 300, moveSpeed: { x: 0.4, y: 0.5 }, joinCode: "5,brazil,br" },
      { name: "Russia", imgUrl: "RU.png", size: initialCountrySize, users: [], x: 200, y: 100, moveSpeed: { x: 0.5, y: 0.5 }, joinCode: "6,russia,ru" },
      { name: "China", imgUrl: "CN.png", size: initialCountrySize, users: [], x: 150, y: 150, moveSpeed: { x: 0.5, y: 0.5 }, joinCode: "7,china,cn" },
      { name: "India", imgUrl: "IN.png", size: initialCountrySize, users: [], x: 50, y: 50, moveSpeed: { x: 0.8, y: 0.4 }, joinCode: "8,india,in" },
      { name: "Japan", imgUrl: "JP.png", size: initialCountrySize, users: [], x: 250, y: 250, moveSpeed: { x: 0.5, y: 0.5 }, joinCode: "9,japan,jp" },
      { name: "Canada", imgUrl: "CA.png", size: initialCountrySize, users: [], x: 300, y: 300, moveSpeed: { x: 0.3, y: 0.3 }, joinCode: "10,canada,ca" },
      { name: "England", imgUrl: "ENG.png", size: initialCountrySize, users: [], x: 100, y: 300, moveSpeed: { x: 0.5, y: 0.5 }, joinCode: "11,england,eng" },
      { name: "Italy", imgUrl: "IT.png", size: initialCountrySize, users: [], x: 200, y: 50, moveSpeed: { x: 0.5, y: 0.5 }, joinCode: "12,italy,it" },
      { name: "Azerbaijan", imgUrl: "AZ.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.9, y: 0.5 }, joinCode: "13,azerbaijan,az,aze" },
      { name: "Ukraine", imgUrl: "UA.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.2, y: 0.5 }, joinCode: "14,ukraine,ua" },
      { name: "Afghanistan", imgUrl: "AF.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.2, y: 0.5 }, joinCode: "15,afghanistan,af" },
      { name: "Palestine", imgUrl: "PS.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.2, y: 0.5 }, joinCode: "16,palestine,ps" },
      { name: "Belgium", imgUrl: "BE.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.2, y: 0.5 }, joinCode: "17,Belgium,be" },
      { name: "Malaysia", imgUrl: "MY.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.2, y: 0.5 }, joinCode: "18,palestine,ps" },
      { name: "Philippines", imgUrl: "PH.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.2, y: 0.5 }, joinCode: "19,palestine,ps" },
      { name: "Armenia", imgUrl: "AM.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.2, y: 0.5 }, joinCode: "20,palestine,ps" },
      { name: "Kazakhstan", imgUrl: "KZ.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.4, y: 0.3 }, joinCode: "21,kazakhstan,kz" },
      { name: "Uzbekistan", imgUrl: "UZ.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.3, y: 0.6 }, joinCode: "22,uzbekistan,uz" },
      { name: "Argentina", imgUrl: "AR.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.5, y: 0.4 }, joinCode: "23,argentina,ar" },
      { name: "Vietnam", imgUrl: "VN.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.2, y: 0.7 }, joinCode: "24,vietnam,vn" },
      { name: "Finland", imgUrl: "FI.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.6, y: 0.3 }, joinCode: "25,finland,fi" },
      { name: "Greece", imgUrl: "GR.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.4, y: 0.8 }, joinCode: "26,greece,gr" },
      { name: "Albania", imgUrl: "AL.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.7, y: 0.5 }, joinCode: "27,albania,al" },
      { name: "Korea", imgUrl: "KR.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.9, y: 0.7 }, joinCode: "28,korea,kr" },
      { name: "Saudi Arabia", imgUrl: "SA.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.5, y: 0.3 }, joinCode: "29,saudi arabia,sa" },
      { name: "Israel", imgUrl: "IL.png", size: initialCountrySize, users: [], x: 0, y: 0, moveSpeed: { x: 0.3, y: 0.4 }, joinCode: "30,israel,il" },

    ];
    let finishGame = false;
    let animationID;
    const maxCountrySize = 400; // Oyunun bitmesi için gerekli maksimum boyut
    // Global olarak resimleri yükleyelim
    const images = {};




countries.forEach((country) => {
  const img = new Image();
  img.src = country.imgUrl;
  
  img.onload = function() {
    images[country.name] = img; // Resim başarıyla yüklendiğinde kaydediyoruz
  };
  
  img.onerror = function() {
    console.error(`Resim yüklenemedi: ${country.imgUrl} (Ülke: ${country.name})`);
  };
});

function drawCountries() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  countries.sort((a, b) => a.size - b.size); // Küçükten büyüğe sırala

  countries.forEach((country) => {
    const img = images[country.name];  // Önceden yüklenmiş resmi kullanıyoruz

    // Resmin tamamen yüklenmiş olup olmadığını kontrol edin
    if (img && img.complete && img.naturalWidth !== 0) {
      ctx.save();
      ctx.beginPath();
      ctx.arc(country.x + country.size / 2, country.y + country.size / 2, country.size / 2, 0, 2 * Math.PI);
      ctx.clip();  // Daire şeklinde clip bölgesi oluştur

      ctx.drawImage(img, country.x, country.y, country.size, country.size);
      ctx.restore();

      // Yeşil border ekleme
      ctx.strokeStyle = "green";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(country.x + country.size / 2, country.y + country.size / 2, country.size / 2, 0, 2 * Math.PI);
      ctx.stroke();
    } else {
      console.warn(`Resim henüz yüklenmemiş veya hatalı: ${country.name}`);
    }

    country.x += country.moveSpeed.x;
    country.y += country.moveSpeed.y;

    // Duvara çarpma kontrolü ve yön değiştirme
    if (country.x + country.size > canvas.width) {
      country.x = canvas.width - country.size;
      country.moveSpeed.x *= -1;
    }
    if (country.x < 0) {
      country.x = 0;
      country.moveSpeed.x *= -1;
    }
    if (country.y + country.size > canvas.height) {
      country.y = canvas.height - country.size;
      country.moveSpeed.y *= -1;
    }
    if (country.y < 0) {
      country.y = 0;
      country.moveSpeed.y *= -1;
    }
  });

  checkWinningCountry();
  updateProgressCanvas(); // Progress canvas'ı güncelle
}

    // Sayfa yüklendiğinde yeniden çizimi başlat
    $(document).ready(() => {
      drawCountries();
    });

    $(document).ready(() => {
      animationID = setInterval(drawCountries, 1000 / 60); // 60 FPS ile ülkeleri hareket ettir
      setTimeout(function () {
        let targetLive = "azbesdir";
        connect(targetLive);
      }, 5000);
    });

    function connect(targetLive) {
      if (targetLive !== '') {
        $('#stateText').text('Qoşulur...');
        $("#usernameTarget").html("@" + targetLive);
        connection.connect(targetLive, {
          enableExtendedGiftInfo: true
        }).then(state => {
          $('#stateText').text(`Xoş gəldin... ${state.roomId}`);
        }).catch(errorMessage => {
          $('#stateText').text(errorMessage);
        });
      } else {
        alert('İstifadəçi adını daxil et');
      }
    }

    function removeUserFromPreviousCountry(userName) {
      countries.forEach(country => {
        const userIndex = country.users.findIndex(user => user.name === userName);
        if (userIndex !== -1) {
          country.users.splice(userIndex, 1);
          console.log(`${userName} ${country.name} ülkesinden çıkarıldı.`);
        }
      });
    }

    connection.on('chat', (data) => {
      if (finishGame) return;

      let userName = data.uniqueId;
      let profilePictureUrl = data.profilePictureUrl;
      let selectedCountry = selectCountryByJoinCode(data.comment);

      if (selectedCountry) {
        removeUserFromPreviousCountry(userName);
        selectedCountry.users.push({ name: userName, profilePictureUrl });
        selectedCountry.size += 0.3;
        console.log(`${userName} seçtiği ülke: ${selectedCountry.name}`);
        drawCountries();
      }
    });

    function showCountryEffect(country) {
      // Mevcut ülke pozisyonunu al
      const x = country.x;
      const y = country.y;
      const size = country.size;

      // Işık halkası efekti
      ctx.save();
      ctx.shadowColor = 'rgba(255, 255, 0, 1)'; // Parlak sarı ışık
      ctx.shadowBlur = 20; // Işık halkasının bulanıklığı
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;

      ctx.beginPath();
      ctx.arc(x + size / 2, y + size / 2, size / 2, 0, 2 * Math.PI);
      ctx.strokeStyle = 'rgba(255, 255, 0, 0.8)';
      ctx.lineWidth = 10; // Kalın ışık halkası
      ctx.stroke();
      ctx.restore();

      // 500 milisaniye sonra efekti kaldır
      setTimeout(() => {
        ctx.clearRect(x - 10, y - 10, size + 20, size + 20); // Efekti temizle
        ctx.drawImage(images[country.name], x, y, size, size); // Ülkeyi tekrar çiz
        ctx.strokeStyle = "green"; // Yeşil sınır efekti
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(x + size / 2, y + size / 2, size / 2, 0, 2 * Math.PI);
        ctx.stroke();
      }, 500); // 500 milisaniye sonra efekti kaldır
    }


    function shakeCanvas() {
      canvas.classList.add('shake');

      // 500ms sonra shake sınıfını kaldırarak sallanmayı durdur
      setTimeout(() => {
        canvas.classList.remove('shake');
      }, 500); // Shake süresiyle aynı olmalı
    }


    connection.on('gift', (data) => {
      if (finishGame) return;

      let userName = data.uniqueId;
      let profilePictureUrl = data.profilePictureUrl;
      let giftCount = data.diamondCount * data.repeatCount;

      let selectedCountry = countries.find(country => country.users.some(user => user.name === userName));
      if (!isPendingStreak(data) && data.diamondCount > 0) {
      if (selectedCountry) {
        selectedCountry.size += giftCount * 2;

        // Ülkenin resminin içinde bir efekt oluştur
        showCountryEffect(selectedCountry);

        // Gift count 30 veya daha fazlaysa shake efekti ve mp3 çalma
        if (giftCount >= 30) {
          playSound('run.mp3'); // 30 ve üstü için çalacak mp3
          shakeCanvas();
        } else {
          playSound('gun.mp3'); // 30'dan az için çalacak mp3

        }

      }

        console.log(`${userName} adlı kullanıcı ${selectedCountry.name} ülkesine hediye gönderdi. Ülke boyutu: ${selectedCountry.size}px`);
        drawCountries();
      } else {
        console.log(`${userName} için ülke bulunamadı.`);
      }
    });

    function isPendingStreak(data) {
    return data.giftType === 1 && !data.repeatEnd;
}

    let currentAudio = null; // Şu anda çalan müziği takip etmek için global değişken

    function playSound(mp3File) {
      // Eğer bir müzik zaten çalıyorsa durmasını bekleyelim
      if (currentAudio && !currentAudio.paused) {
        currentAudio.onended = function () { // Şu anki müzik bittiğinde yeni müziği çal
          currentAudio = new Audio(mp3File);
          currentAudio.play();
        };
      } else {
        // Eğer hiçbir müzik çalmıyorsa doğrudan yeni müziği çal
        currentAudio = new Audio(mp3File);
        currentAudio.play();
      }
    }


    function selectCountryByJoinCode(comment) {
      let foundCountry = countries.find(country => {
        return country.joinCode.split(',').includes(comment.toLowerCase());
      });
      return foundCountry;
    }

    function checkWinningCountry() {
      let largestCountry = countries.reduce((max, country) => max.size > country.size ? max : country);
      if (largestCountry.size >= 400) {
        finishGame = true;
        showFireworkGif(largestCountry);
      }
    }

    function showFireworkGif(winningCountry) {
      // Hareketi durdur
      clearInterval(animationID);

      // Kazanan ülkenin resmiyle beraber "Congratulations" animasyonunu göster
      drawText(winningCountry);
    }

    function drawText(winningCountry) {
      function drawAnimatedText() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();

        const img = new Image();
        img.src = winningCountry.imgUrl;
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        const colors = ["red", "orange", "yellow", "green", "blue", "indigo", "violet"];
        let color = colors[Math.floor(Math.random() * colors.length)];

        ctx.fillStyle = color;
        ctx.font = "bold 30px Arial";
        ctx.textAlign = "center";
        ctx.fillText("Congratulations!", canvas.width / 2, canvas.height / 2 - 50);

        ctx.fillStyle = color;
        ctx.font = "bold 30px Arial";
        ctx.fillText(winningCountry.name, canvas.width / 2, canvas.height / 2);

        ctx.restore();
        animationID = requestAnimationFrame(drawAnimatedText);
      }

      drawAnimatedText();

      setTimeout(() => {
        cancelAnimationFrame(animationID);  // Animasyonu durdur
        showTop5(winningCountry);  // Top 5 göster
      }, 5000);  // 5 saniye sonra Top 5 gösterilecek
    }
    function showTop5(winningCountry) {
      const top5Users = winningCountry.users.slice(0, 5);

      // Clear the canvas for the top 5 display
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Set the background color for the top 5 section
      ctx.fillStyle = "rgba(0, 0, 0, 0.8)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Iterate through top 5 users
      top5Users.forEach((user, index) => {
        const img = new Image();
        img.src = user.profilePictureUrl;
        img.onload = function () {
          const imgSize = 25;  // Further reduced size for profile images
          const medalSize = 20; // Further reduced size for medals
          const yOffset = 80 + index * 40; // Further reduced vertical spacing

          // Draw the medal circle
          ctx.save();
          ctx.beginPath();
          ctx.arc(50, yOffset, medalSize / 2, 0, 2 * Math.PI);
          ctx.closePath();
          ctx.fillStyle = index === 0 ? "gold" : index === 1 ? "silver" : "bronze";
          ctx.fill();

          // Draw the rank number
          ctx.font = "bold 14px Arial";  // Smaller font for rank numbers
          ctx.fillStyle = "black";
          ctx.textAlign = "center";
          ctx.fillText(index + 1, 50, yOffset + 4);

          // Draw the user's profile picture
          ctx.beginPath();
          ctx.arc(120, yOffset, imgSize / 2, 0, 2 * Math.PI);
          ctx.closePath();
          ctx.clip();
          ctx.drawImage(img, 108, yOffset - imgSize / 2, imgSize, imgSize);
          ctx.restore();

          // Draw the username
          ctx.fillStyle = "white";
          ctx.font = "bold 16px Arial";  // Smaller font for usernames
          ctx.textAlign = "left";
          ctx.fillText(user.name, 150, yOffset + 4);

          // Draw the user's points (gifts)
          // ctx.font = "14px Arial";  // Smaller font for points
          // ctx.fillStyle = "yellow";
          // ctx.fillText(`${winningCountry.size}`, canvas.width - 80, yOffset + 4);
        };
      });

      // Display Congratulations Text
      ctx.font = "bold 24px Arial";  // Smaller font for "Congratulations" text
      ctx.fillStyle = "white";
      ctx.textAlign = "center";
      ctx.fillText("Winner!", canvas.width / 2, 40);

      ctx.font = "bold 18px Arial";  // Smaller font for country name
      ctx.fillText(winningCountry.name, canvas.width / 2, 60);

      // Reset the game after displaying the top 5 for 5 seconds
      setTimeout(resetGame, 5000);
    }

    function resetGame() {
  countries.forEach(country => {
    country.size = initialCountrySize;
    country.users = [];  // Kullanıcı listesini sıfırla
  });
  finishGame = false;
  countdownTime = 30; // Geri sayım süresini tekrar başlat
  ctx.clearRect(0, 0, canvas.width, canvas.height); // Canvas'ı temizle
  animationID = setInterval(drawCountries, 1000 / 60); // Hareketi yeniden başlat
  startCountdown(); // Geri sayımı yeniden başlat
}
    function updateProgressCanvas() {
      progressCtx.clearRect(0, 0, progressCanvas.width, progressCanvas.height);

      const largestCountry = countries.reduce((max, country) => max.size > country.size ? max : country);
      const progress = Math.min((largestCountry.size / maxCountrySize) * 100, 100); // Yüzdeyi hesapla

      // Ülkenin resmi
      const img = images[largestCountry.name];
      progressCtx.drawImage(img, 10, 20, 50, 50);

      // Ülkenin adı ve pozisyonu
      progressCtx.fillStyle = "red";
      progressCtx.font = "bold 20px Arial";
      progressCtx.fillText(largestCountry.name, 110, 35);
      progressCtx.font = "bold 16px Arial";
      progressCtx.fillText("1st Place", 110, 55);

      // Progress bar
      progressCtx.fillStyle = "rgba(0, 0, 0, 0.1)";
      progressCtx.fillRect(10, 80, 380, 12); // Progress bar arka planı

      progressCtx.fillStyle = "#4CAF50";
      progressCtx.fillRect(10, 80, progress * 3.8, 12); // İlerleme çubuğu genişliği

      // Yüzde olarak gösterim
      progressCtx.fillStyle = "#333";
      progressCtx.font = "bold 14px Arial";
      progressCtx.fillText(`${Math.floor(progress)}%`, 370, 90); // Yüzde değeri


      // Yüzdelik rakamını altta, ortada göstermek için
      progressCtx.font = "bold 20px Arial";
      progressCtx.fillStyle = "#333";
      progressCtx.textAlign = "center";
      progressCtx.fillText(`${Math.floor(progress)}%`, progressCanvas.width / 2, progressCanvas.height - 10); // Yüzdelik değeri altında göster

    }

  </script>
</body>

</html>
